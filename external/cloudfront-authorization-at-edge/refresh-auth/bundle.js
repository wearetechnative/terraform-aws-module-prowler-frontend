/*! For license information please see bundle.js.LICENSE.txt */
(()=>{"use strict";var e={932:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.deconstructPublicKeyInDerFormat=t.constructPublicKeyInDerFormat=void 0;const o=r(625);var i,n,s;function a(e){const t=e.class<<7|e.primitiveOrConstructed<<5|e.tag;return Buffer.from([t])}function c(e){if(e<128)return Buffer.from([e]);const t=[];for(;e>0;)t.push(e%256),e>>=8;return t.reverse(),Buffer.from([128|t.length,...t])}function d(e){return Buffer.concat([a({class:i.Universal,primitiveOrConstructed:n.Primitive,tag:s.Integer}),c(e.length),e])}function l(e){const t=Buffer.concat([Buffer.from([0]),e]);return Buffer.concat([a({class:i.Universal,primitiveOrConstructed:n.Primitive,tag:s.BitString}),c(t.length),t])}function u(e){const t=Buffer.concat(e);return Buffer.concat([a({class:i.Universal,primitiveOrConstructed:n.Constructed,tag:s.Sequence}),c(t.length),t])}!function(e){e[e.Universal=0]="Universal"}(i||(i={})),function(e){e[e.Primitive=0]="Primitive",e[e.Constructed=1]="Constructed"}(n||(n={})),function(e){e[e.BitString=3]="BitString",e[e.ObjectIdentifier=6]="ObjectIdentifier",e[e.Sequence=16]="Sequence",e[e.Null=5]="Null",e[e.Integer=2]="Integer"}(s||(s={}));const f=u([function(e){const t=e.split(".").map((e=>parseInt(e))),r=40*t[0]+t[1],o=t.slice(2).reduce(((e,t)=>{const r=[];do{r.push(t%128),t>>=7}while(t);return e.concat(r.map(((e,t)=>t?e+128:e)).reverse())}),[]),d=Buffer.from([r,...o]);return Buffer.concat([a({class:i.Universal,primitiveOrConstructed:n.Primitive,tag:s.ObjectIdentifier}),c(d.length),d])}("1.2.840.113549.1.1.1"),Buffer.concat([a({class:i.Universal,primitiveOrConstructed:n.Primitive,tag:s.Null}),c(0)])]);function h(e){if(e>>3==31)throw new o.Asn1DecodingError("Decoding of identifier with tag > 30 not implemented");return{class:e>>6,primitiveOrConstructed:e>>5&1,tag:31&e}}function w(e){if(!(128&e[0]))return{length:e[0],firstByteOffset:1,lastByteOffset:1+e[0]};const t=127&e[0],r=Buffer.from(e.slice(1,2+t)).readUIntBE(0,t);return{length:r,firstByteOffset:1+t,lastByteOffset:1+t+r}}function p(e){const{tag:t}=h(e[0]);if(t!==s.Sequence)throw new o.Asn1DecodingError(`Expected a sequence to decode, but got tag ${t}`);const{firstByteOffset:r,lastByteOffset:i}=w(e.slice(1)),n=e.slice(1+r,2+i),a=[];let c=0;for(;c<n.length;){const e=h(n[c]),t=w(n.slice(c+1)),r=n.slice(c+1+t.firstByteOffset,c+1+t.lastByteOffset);a.push({identifier:e,length:t.length,value:r}),c+=1+t.lastByteOffset}return a}t.constructPublicKeyInDerFormat=function(e,t){return u([f,l(u([d(e),d(t)]))])},t.deconstructPublicKeyInDerFormat=function(e){const[,t]=p(e),[r,o]=p(t.value.slice(1));return{n:r.value,e:o.value}}},707:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.assertStringArraysOverlap=t.assertStringArrayContainsString=t.assertStringEquals=void 0;const o=r(625);function i(e,t,r){if(!t)throw new o.AssertionError(`Missing ${e}. ${n(r)}`);const i=new Set(Array.isArray(r)?r:[r]);if("string"==typeof t&&(t=[t]),!Array.isArray(t))throw new o.AssertionError(`${e} is not an array`);if(!t.some((t=>{if("string"!=typeof t)throw new o.AssertionError(`${e} includes elements that are not of type string`);return i.has(t)})))throw new o.AssertionError(`${e} not allowed: ${t.join(", ")}. ${n(r)}`)}function n(e){return Array.isArray(e)?e.length>1?`Expected one of: ${e.join(", ")}`:`Expected: ${e[0]}`:`Expected: ${e}`}t.assertStringEquals=function(e,t,r){if(!t)throw new o.AssertionError(`Missing ${e}. Expected: ${r}`);if("string"!=typeof t)throw new o.AssertionError(`${e} is not of type string`);if(r!==t)throw new o.AssertionError(`${e} not allowed: ${t}. Expected: ${r}`)},t.assertStringArrayContainsString=function(e,t,r){if(!t)throw new o.AssertionError(`Missing ${e}. ${n(r)}`);if("string"!=typeof t)throw new o.AssertionError(`${e} is not of type string`);return i(e,t,r)},t.assertStringArraysOverlap=i},253:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.CognitoJwtVerifier=void 0;const o=r(625),i=r(999),n=r(707);function s(e,t){if(null!=t.groups&&(0,n.assertStringArraysOverlap)("Cognito group",e["cognito:groups"],t.groups),(0,n.assertStringArrayContainsString)("Token use",e.token_use,["id","access"]),null!==t.tokenUse){if(void 0===t.tokenUse)throw new o.ParameterValidationError("tokenUse must be provided or set to null explicitly");(0,n.assertStringEquals)("Token use",e.token_use,t.tokenUse)}if(null!==t.clientId){if(void 0===t.clientId)throw new o.ParameterValidationError("clientId must be provided or set to null explicitly");"id"===e.token_use?(0,n.assertStringArrayContainsString)('Client ID ("audience")',e.aud,t.clientId):(0,n.assertStringArrayContainsString)("Client ID",e.client_id,t.clientId)}}class a extends i.JwtRsaVerifierBase{constructor(e,t){super(Array.isArray(e)?e.map((e=>({...e,...a.parseUserPoolId(e.userPoolId),audience:null}))):{...e,...a.parseUserPoolId(e.userPoolId),audience:null},t)}static parseUserPoolId(e){const t=e.match(/^(?<region>(\w+-)?\w+-\w+-\d)+_\w+$/);if(!t)throw new o.ParameterValidationError(`Invalid Cognito User Pool ID: ${e}`);const r=`https://cognito-idp.${t.groups.region}.amazonaws.com/${e}`;return{issuer:r,jwksUri:`${r}/.well-known/jwks.json`}}static create(e,t){return new this(e,t?.jwksCache)}verifySync(...e){const t=super.verifySync(...e);return s(t,{...this.getIssuerConfig(t.iss),...e[1]}),t}async verify(...e){const t=await super.verify(...e);return s(t,{...this.getIssuerConfig(t.iss),...e[1]}),t}cacheJwks(...e){let t;if(void 0!==e[1])t=a.parseUserPoolId(e[1]).issuer;else if(this.expectedIssuers.length>1)throw new o.ParameterValidationError("userPoolId must be provided");const r=this.getIssuerConfig(t);super.cacheJwks(e[0],r.issuer)}}t.CognitoJwtVerifier=a},625:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.AssertionError=t.NonRetryableFetchError=t.FetchError=t.JwksNotAvailableInCacheError=t.WaitPeriodNotYetEndedJwkError=t.KidNotFoundInJwksError=t.JwtWithoutValidKidError=t.JwkValidationError=t.JwksValidationError=t.Asn1DecodingError=t.JwtInvalidClaimError=t.ParameterValidationError=t.JwtNotBeforeError=t.JwtExpiredError=t.JwtInvalidSignatureError=t.JwtParseError=t.JwtBaseError=void 0;class r extends Error{}t.JwtBaseError=r;t.JwtParseError=class extends r{constructor(e,t){super(null!=t?`${e}: ${t}`:e)}};t.JwtInvalidSignatureError=class extends r{};t.JwtExpiredError=class extends r{};t.JwtNotBeforeError=class extends r{};t.ParameterValidationError=class extends r{};t.JwtInvalidClaimError=class extends r{};t.Asn1DecodingError=class extends r{};t.JwksValidationError=class extends r{};t.JwkValidationError=class extends r{};t.JwtWithoutValidKidError=class extends r{};t.KidNotFoundInJwksError=class extends r{};t.WaitPeriodNotYetEndedJwkError=class extends r{};t.JwksNotAvailableInCacheError=class extends r{};class o extends r{constructor(e,t){super(`Failed to fetch ${e}: ${t}`)}}t.FetchError=o;t.NonRetryableFetchError=class extends o{};t.AssertionError=class extends r{}},829:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.fetchJson=t.SimpleJsonFetcher=void 0;const o=r(211),i=r(413),n=r(669),s=r(784),a=r(625);async function c(e,t,r){let n;return new Promise(((s,c)=>{const l=(0,o.request)(e,{method:"GET",...t},(t=>{i.pipeline([t,d(e,t.statusCode,t.headers)],u)}));function u(...t){if(n&&clearTimeout(n),null==t[0])return void s(t[1]);l.socket?.emit("agentRemove");let r=t[0];r instanceof a.FetchError||(r=new a.FetchError(e,r.message)),l.destroy(),c(r)}t?.responseTimeout&&(n=setTimeout((()=>u(new a.FetchError(e,`Response time-out (after ${t.responseTimeout} ms.)`))),t.responseTimeout),n.unref()),l.on("error",u),l.end(r)}))}function d(e,t,r){return async o=>{if(429===t)throw new a.FetchError(e,"Too many requests");if(200!==t)throw new a.NonRetryableFetchError(e,`Status code is ${t}, expected 200`);if(!r["content-type"]?.toLowerCase().startsWith("application/json"))throw new a.NonRetryableFetchError(e,`Content-type is "${r["content-type"]}", expected "application/json"`);const i=[];for await(const e of o)i.push(e);try{return(0,s.safeJsonParse)(new n.TextDecoder("utf8",{fatal:!0,ignoreBOM:!0}).decode(Buffer.concat(i)))}catch(t){throw new a.NonRetryableFetchError(e,t)}}}t.SimpleJsonFetcher=class{constructor(e){this.defaultRequestOptions={timeout:500,responseTimeout:1500,...e?.defaultRequestOptions}}async fetch(e,t,r){t={...this.defaultRequestOptions,...t};try{return await c(e,t,r)}catch(o){if(o instanceof a.NonRetryableFetchError)throw o;return c(e,t,r)}}},t.fetchJson=c},48:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.CognitoJwtVerifier=t.JwtRsaVerifier=void 0;var o=r(999);Object.defineProperty(t,"JwtRsaVerifier",{enumerable:!0,get:function(){return o.JwtRsaVerifier}});var i=r(253);Object.defineProperty(t,"CognitoJwtVerifier",{enumerable:!0,get:function(){return i.CognitoJwtVerifier}})},308:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.SimpleJwksCache=t.SimplePenaltyBox=t.isJwk=t.isJwks=t.assertIsJwk=t.assertIsJwks=t.fetchJwk=t.fetchJwks=void 0;const o=r(829),i=r(784),n=r(625),s=["alg","e","kid","kty","n","use"];async function a(e){const t=await(0,o.fetchJson)(e);return c(t),t}function c(e){if(!e)throw new n.JwksValidationError("JWKS empty");if(!(0,i.isJsonObject)(e))throw new n.JwksValidationError("JWKS should be an object");if(!Object.keys(e).includes("keys"))throw new n.JwksValidationError("JWKS does not include keys");if(!Array.isArray(e.keys))throw new n.JwksValidationError("JWKS keys should be an array");for(const t of e.keys)d(t)}function d(e){if(!e)throw new n.JwkValidationError("JWK empty");if(!(0,i.isJsonObject)(e))throw new n.JwkValidationError("JWK should be an object");for(const t of s)if(!(t in e))throw new n.JwkValidationError(`JWK ${t} should be a string`)}t.fetchJwks=a,t.fetchJwk=async function(e,t){if(!t.header.kid)throw new n.JwtWithoutValidKidError("JWT header does not have valid kid claim");const r=(await a(e)).keys.find((e=>e.kid===t.header.kid));if(!r)throw new n.KidNotFoundInJwksError(`JWK for kid "${t.header.kid}" not found in the JWKS`);return r},t.assertIsJwks=c,t.assertIsJwk=d,t.isJwks=function(e){try{return c(e),!0}catch{return!1}},t.isJwk=function(e){try{return d(e),!0}catch{return!1}};class l{constructor(e){this.waitingUris=new Map,this.waitSeconds=e?.waitSeconds??10}async wait(e){if(this.waitingUris.has(e))throw new n.WaitPeriodNotYetEndedJwkError("Not allowed to fetch JWKS yet, still waiting for back off period to end")}release(e){const t=this.waitingUris.get(e);t&&(clearTimeout(t),this.waitingUris.delete(e))}registerFailedAttempt(e){const t=setTimeout((()=>{this.waitingUris.delete(e)}),1e3*this.waitSeconds).unref();this.waitingUris.set(e,t)}registerSuccessfulAttempt(e){this.release(e)}}t.SimplePenaltyBox=l;t.SimpleJwksCache=class{constructor(e){this.jwksCache=new Map,this.fetchingJwks=new Map,this.penaltyBox=e?.penaltyBox??new l,this.fetcher=e?.fetcher??new o.SimpleJsonFetcher}addJwks(e,t){this.jwksCache.set(e,t)}async getJwks(e){const t=this.fetchingJwks.get(e);if(t)return t;const r=this.fetcher.fetch(e).then((e=>(c(e),e)));let o;this.fetchingJwks.set(e,r);try{o=await r}finally{this.fetchingJwks.delete(e)}return this.jwksCache.set(e,o),o}getCachedJwk(e,t){if("string"!=typeof t.header.kid)throw new n.JwtWithoutValidKidError("JWT header does not have valid kid claim");if(!this.jwksCache.has(e))throw new n.JwksNotAvailableInCacheError(`JWKS for uri ${e} not yet available in cache`);const r=this.jwksCache.get(e).keys.find((e=>e.kid===t.header.kid));if(!r)throw new n.KidNotFoundInJwksError(`JWK for kid ${t.header.kid} not found in the JWKS`);return r}async getJwk(e,t){if("string"!=typeof t.header.kid)throw new n.JwtWithoutValidKidError("JWT header does not have valid kid claim");let r=this.jwksCache.get(e)?.keys.find((e=>e.kid===t.header.kid));if(r)return r;await this.penaltyBox.wait(e,t.header.kid);if(r=(await this.getJwks(e)).keys.find((e=>e.kid===t.header.kid)),!r)throw this.penaltyBox.registerFailedAttempt(e,t.header.kid),new n.KidNotFoundInJwksError(`JWK for kid "${t.header.kid}" not found in the JWKS`);return this.penaltyBox.registerSuccessfulAttempt(e,t.header.kid),r}}},999:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.KeyObjectCache=t.transformJwkToKeyObject=t.JwtRsaVerifier=t.JwtRsaVerifierBase=t.verifyJwtSync=t.verifyJwt=void 0;const o=r(417),i=r(835),n=r(622),s=r(308),a=r(932),c=r(707),d=r(403),l=r(625);function u(e,r,i,n,s,a,d=t.transformJwkToKeyObject){(0,c.assertStringEquals)("JWK use",a.use,"sig"),(0,c.assertStringEquals)("JWT signature algorithm",e.alg,a.alg),(0,c.assertStringEquals)("JWT signature algorithm",e.alg,"RS256");const u=d(a,i.iss,e.kid);if(!(0,o.createVerify)("RSA-SHA256").update(`${r}.${n}`).verify(u,s,"base64"))throw new l.JwtInvalidSignatureError("Invalid signature")}async function f(e,t,r,o=s.fetchJwk,i){const{header:n,headerB64:a,payload:c,payloadB64:l,signatureB64:f}=e;(0,d.validateJwtFields)(c,r);const h=await o(t,e);return u(n,a,c,l,f,h,i),r.customJwtCheck&&await r.customJwtCheck({header:n,payload:c,jwk:h}),c}function h(e,t,r,o){const{header:i,headerB64:n,payload:a,payloadB64:c,signatureB64:f}=e;let h;if((0,d.validateJwtFields)(a,r),(0,s.isJwk)(t))h=t;else{if(!(0,s.isJwks)(t))throw new l.ParameterValidationError([`Expected a valid JWK or JWKS (parsed as JavaScript object), but received: ${t}.`,"If you're passing a JWKS URI, use the async verify() method instead, it will download and parse the JWKS for you"].join());{const e=t.keys.find((e=>e.kid===i.kid));if(!e)throw new l.KidNotFoundInJwksError(`JWK for kid ${i.kid} not found in the JWKS`);h=e}}if(u(i,n,a,c,f,h,o),r.customJwtCheck){const e=r.customJwtCheck({header:i,payload:a,jwk:h});if(void 0!==e&&e instanceof Promise)throw new l.ParameterValidationError("Custom JWT checks must be synchronous but a promise was returned")}return a}t.verifyJwt=async function(e,t,r,o,i){return f((0,d.decomposeJwt)(e),t,r,o,i)},t.verifyJwtSync=function(e,t,r,o){return h((0,d.decomposeJwt)(e),t,r,o)};class w{constructor(e,t=new s.SimpleJwksCache){if(this.jwksCache=t,this.issuersConfig=new Map,this.publicKeyCache=new p,Array.isArray(e)){if(!e.length)throw new l.ParameterValidationError("Provide at least one issuer configuration");for(const t of e){if(this.issuersConfig.has(t.issuer))throw new l.ParameterValidationError(`issuer ${t.issuer} supplied multiple times`);this.issuersConfig.set(t.issuer,this.withJwksUri(t))}}else this.issuersConfig.set(e.issuer,this.withJwksUri(e))}get expectedIssuers(){return Array.from(this.issuersConfig.keys())}getIssuerConfig(e){if(!e){if(1!==this.issuersConfig.size)throw new l.ParameterValidationError("issuer must be provided");e=this.issuersConfig.keys().next().value}const t=this.issuersConfig.get(e);if(!t)throw new l.ParameterValidationError(`issuer not configured: ${e}`);return t}cacheJwks(...e){const t=this.getIssuerConfig(e[1]);this.jwksCache.addJwks(t.jwksUri,e[0]),this.publicKeyCache.clearCache(t.issuer)}async hydrate(){const e=this.expectedIssuers.map((e=>this.getIssuerConfig(e).jwksUri)).map((e=>this.jwksCache.getJwks(e)));await Promise.all(e)}verifySync(...e){const{decomposedJwt:t,jwksUri:r,verifyProperties:o}=this.getVerifyParameters(e[0],e[1]);return h(t,this.jwksCache.getCachedJwk(r,t),o,this.publicKeyCache.transformJwkToKeyObject.bind(this.publicKeyCache))}async verify(...e){const{decomposedJwt:t,jwksUri:r,verifyProperties:o}=this.getVerifyParameters(e[0],e[1]);return f(t,r,o,this.jwksCache.getJwk.bind(this.jwksCache),this.publicKeyCache.transformJwkToKeyObject.bind(this.publicKeyCache))}getVerifyParameters(e,t){const r=(0,d.decomposeJwt)(e);if(!r.payload.iss)throw new l.JwtInvalidClaimError("JWT payload does not have iss claim");(0,c.assertStringArrayContainsString)("Issuer",r.payload.iss,this.expectedIssuers);const o=this.getIssuerConfig(r.payload.iss);return{decomposedJwt:r,jwksUri:o.jwksUri,verifyProperties:{...o,...t}}}withJwksUri(e){if(e.jwksUri)return e;const t=new i.URL(e.issuer);return{jwksUri:new i.URL((0,n.join)(t.pathname,"/.well-known/jwks.json"),e.issuer).href,...e}}}t.JwtRsaVerifierBase=w;t.JwtRsaVerifier=class extends w{static create(e,t){return new this(e,t?.jwksCache)}};t.transformJwkToKeyObject=e=>(0,o.createPublicKey)({key:(0,a.constructPublicKeyInDerFormat)(Buffer.from(e.n,"base64"),Buffer.from(e.e,"base64")),format:"der",type:"spki"});class p{constructor(e=t.transformJwkToKeyObject){this.jwkToKeyObjectTransformer=e,this.publicKeys=new Map}transformJwkToKeyObject(e,t){if(!t)return this.jwkToKeyObjectTransformer(e);const r=this.publicKeys.get(t)?.get(e.kid);if(r)return r;const o=this.jwkToKeyObjectTransformer(e),i=this.publicKeys.get(t);return i?i.set(e.kid,o):this.publicKeys.set(t,new Map([[e.kid,o]])),o}clearCache(e){this.publicKeys.delete(e)}}t.KeyObjectCache=p},403:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.validateJwtFields=t.decomposeJwt=void 0;const o=r(707),i=r(784),n=r(625);t.decomposeJwt=function(e){if(!e)throw new n.JwtParseError("Empty JWT");if("string"!=typeof e)throw new n.JwtParseError("JWT is not a string");if(!e.match(/^[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+$/))throw new n.JwtParseError("JWT string does not consist of exactly 3 parts (header, payload, signature)");const[t,r,o]=e.split("."),[s,a]=[t,r].map((e=>Buffer.from(e,"base64").toString("utf8")));let c,d;try{c=(0,i.safeJsonParse)(s)}catch(e){throw new n.JwtParseError("Invalid JWT. Header is not a valid JSON object",e)}!function(e){if(!(0,i.isJsonObject)(e))throw new n.JwtParseError("JWT header is not an object");if(void 0!==e.alg&&"string"!=typeof e.alg)throw new n.JwtParseError("JWT header alg claim is not a string");if(void 0!==e.kid&&"string"!=typeof e.kid)throw new n.JwtParseError("JWT header kid claim is not a string")}(c);try{d=(0,i.safeJsonParse)(a)}catch(e){throw new n.JwtParseError("Invalid JWT. Payload is not a valid JSON object",e)}return function(e){if(!(0,i.isJsonObject)(e))throw new n.JwtParseError("JWT payload is not an object");if(void 0!==e.exp&&!Number.isFinite(e.exp))throw new n.JwtParseError("JWT payload exp claim is not a number");if(void 0!==e.iss&&"string"!=typeof e.iss)throw new n.JwtParseError("JWT payload iss claim is not a string");if(void 0!==e.aud&&"string"!=typeof e.aud&&(!Array.isArray(e.aud)||e.aud.some((e=>"string"!=typeof e))))throw new n.JwtParseError("JWT payload aud claim is not a string or array of strings");if(void 0!==e.nbf&&!Number.isFinite(e.nbf))throw new n.JwtParseError("JWT payload nbf claim is not a number");if(void 0!==e.iat&&!Number.isFinite(e.iat))throw new n.JwtParseError("JWT payload iat claim is not a number");if(void 0!==e.scope&&"string"!=typeof e.scope)throw new n.JwtParseError("JWT payload scope claim is not a string");if(void 0!==e.jti&&"string"!=typeof e.jti)throw new n.JwtParseError("JWT payload jti claim is not a string")}(d),{header:c,headerB64:t,payload:d,payloadB64:r,signatureB64:o}},t.validateJwtFields=function(e,t){if(void 0!==e.exp&&e.exp+(t.graceSeconds??0)<Date.now()/1e3)throw new n.JwtExpiredError(`Token expired at ${new Date(1e3*e.exp).toISOString()}`);if(void 0!==e.nbf&&e.nbf-(t.graceSeconds??0)>Date.now()/1e3)throw new n.JwtNotBeforeError(`Token can't be used before ${new Date(1e3*e.nbf).toISOString()}`);if(null!==t.issuer){if(void 0===t.issuer)throw new n.ParameterValidationError("issuer must be provided or set to null explicitly");(0,o.assertStringArrayContainsString)("Issuer",e.iss,t.issuer)}if(null!==t.audience){if(void 0===t.audience)throw new n.ParameterValidationError("audience must be provided or set to null explicitly");(0,o.assertStringArraysOverlap)("Audience",e.aud,t.audience)}null!=t.scope&&(0,o.assertStringArraysOverlap)("Scope",e.scope?.split(" "),t.scope)}},784:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.safeJsonParse=t.isJsonObject=void 0,t.isJsonObject=function(e){return"object"==typeof e&&!Array.isArray(e)&&null!==e},t.safeJsonParse=function(e){return JSON.parse(e,((e,t)=>("object"!=typeof t||Array.isArray(t)||null===t||(delete t.__proto__,delete t.constructor),t)))}},489:(e,t)=>{t.parse=function(e,t){if("string"!=typeof e)throw new TypeError("argument str must be a string");for(var o={},n=t||{},a=e.split(i),c=n.decode||r,d=0;d<a.length;d++){var l=a[d],u=l.indexOf("=");if(!(u<0)){var f=l.substr(0,u).trim(),h=l.substr(++u,l.length).trim();'"'==h[0]&&(h=h.slice(1,-1)),null==o[f]&&(o[f]=s(h,c))}}return o},t.serialize=function(e,t,r){var i=r||{},s=i.encode||o;if("function"!=typeof s)throw new TypeError("option encode is invalid");if(!n.test(e))throw new TypeError("argument name is invalid");var a=s(t);if(a&&!n.test(a))throw new TypeError("argument val is invalid");var c=e+"="+a;if(null!=i.maxAge){var d=i.maxAge-0;if(isNaN(d)||!isFinite(d))throw new TypeError("option maxAge is invalid");c+="; Max-Age="+Math.floor(d)}if(i.domain){if(!n.test(i.domain))throw new TypeError("option domain is invalid");c+="; Domain="+i.domain}if(i.path){if(!n.test(i.path))throw new TypeError("option path is invalid");c+="; Path="+i.path}if(i.expires){if("function"!=typeof i.expires.toUTCString)throw new TypeError("option expires is invalid");c+="; Expires="+i.expires.toUTCString()}i.httpOnly&&(c+="; HttpOnly");i.secure&&(c+="; Secure");if(i.sameSite){switch("string"==typeof i.sameSite?i.sameSite.toLowerCase():i.sameSite){case!0:c+="; SameSite=Strict";break;case"lax":c+="; SameSite=Lax";break;case"strict":c+="; SameSite=Strict";break;case"none":c+="; SameSite=None";break;default:throw new TypeError("option sameSite is invalid")}}return c};var r=decodeURIComponent,o=encodeURIComponent,i=/; */,n=/^[\u0009\u0020-\u007e\u0080-\u00ff]+$/;function s(e,t){try{return t(e)}catch(t){return e}}},846:(e,t,r)=>{r.r(t),r.d(t,{default:()=>o});const o='<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"/> <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"/> <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous"/> <title>Authorization@Edge</title> <style>html{padding:0}body{display:flex;min-height:100%;margin:0;justify-content:center;align-items:flex-start}.message-card{flex-grow:1;max-width:600px;margin-top:2%}</style> </head> <body> <div class="card message-card"> <h5 class="card-header">Authorization@Edge</h5> <div class="card-body"> <h5 class="card-title">${title}</h5> <p> ${message} <a class="card-link" data-toggle="collapse" href="#details" role="button" aria-expanded="false" aria-controls="details"> ${expandText} </a> </p> <p class="collapse blockquote-footer" id="details"> ${details} [log region: ${region}] </p> <a href="${linkUri}" class="btn btn-primary" role="button">${linkText}</a> </div> </div> <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"><\/script> <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"><\/script> </body> </html> '},910:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.fetch=void 0;const o=r(211),i=r(413);t.fetch=async function(e,t,r){return new Promise(((s,a)=>{const c=o.request(e,null!=r?r:{},(e=>i.pipeline([e,n((t=>s({status:e.statusCode,headers:e.headers,data:t})))],d)));function d(e){e&&(c.destroy(e),a(e))}c.on("error",d),c.end(t)}))};const n=e=>{const t=[];return new i.Writable({write:(e,r,o)=>{try{t.push(e),o()}catch(e){o(e)}},final:r=>{try{e(Buffer.concat(t)),r()}catch(e){r(e)}}})}},326:function(e,t,r){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.RequiresConfirmationError=t.timestampInSeconds=t.sign=t.urlSafe=t.createErrorHtml=t.httpPostToCognitoWithRetry=t.decodeToken=t.generateCookieHeaders=t.extractAndParseCookies=t.getElasticsearchCookieNames=t.getAmplifyCookieNames=t.asCloudFrontHeaders=t.getConfigWithJwtVerifier=t.getCompleteConfig=t.getConfigWithHeaders=t.getConfig=void 0;const i=r(747),n=r(417),s=r(489),a=r(910),c=r(211),d=o(r(846)),l=r(48);var u;!function(e){e[e.none=0]="none",e[e.error=10]="error",e[e.warn=20]="warn",e[e.info=30]="info",e[e.debug=40]="debug"}(u||(u={}));class f{constructor(e){this.logLevel=e}jsonify(e){return e.map((e=>{if("object"==typeof e)try{return JSON.stringify(e)}catch{return e}return e}))}info(...e){this.logLevel>=u.info&&console.log(...this.jsonify(e))}warn(...e){this.logLevel>=u.warn&&console.warn(...this.jsonify(e))}error(...e){this.logLevel>=u.error&&console.error(...this.jsonify(e))}debug(...e){this.logLevel>=u.debug&&console.trace(...this.jsonify(e))}}function h(){const e=JSON.parse(i.readFileSync(`${__dirname}/configuration.json`).toString("utf8"));return{logger:new f(u[e.logLevel]),...e}}function w(){const e=h();if(!function(e){return void 0!==e.httpHeaders}(e))throw new Error("Incomplete config in configuration.json");return{cloudFrontHeaders:y(e.httpHeaders),...e}}function p(){const e=w();if(!function(e){return void 0!==e.userPoolArn}(e))throw new Error("Incomplete config in configuration.json");const t=function(e){if("amplify"===e.compatibility){if("spaMode"===e.mode)return{idToken:"Path=/; Secure; SameSite=Lax",accessToken:"Path=/; Secure; SameSite=Lax",refreshToken:"Path=/; Secure; SameSite=Lax",nonce:"Path=/; Secure; HttpOnly; SameSite=Lax"};if("staticSiteMode"===e.mode)return{idToken:"Path=/; Secure; HttpOnly; SameSite=Lax",accessToken:"Path=/; Secure; HttpOnly; SameSite=Lax",refreshToken:"Path=/; Secure; HttpOnly; SameSite=Lax",nonce:"Path=/; Secure; HttpOnly; SameSite=Lax"}}else if("elasticsearch"===e.compatibility)return{idToken:"Path=/; Secure; HttpOnly; SameSite=Lax",accessToken:"Path=/; Secure; HttpOnly; SameSite=Lax",refreshToken:"Path=/; Secure; HttpOnly; SameSite=Lax",nonce:"Path=/; Secure; HttpOnly; SameSite=Lax",cognitoEnabled:"Path=/; Secure; SameSite=Lax"};throw new Error(`Cannot determine default cookiesettings for ${e.mode} with compatibility ${e.compatibility}`)}({compatibility:e.cookieCompatibility,mode:e.mode}),r=e.cookieSettings?Object.fromEntries(Object.entries({...t,...e.cookieSettings}).map((([e,r])=>[e,r||t[e]]))):t;return{...{secretAllowedCharacters:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",pkceLength:43,nonceLength:16,nonceMaxAge:(null==r?void 0:r.nonce)&&parseInt(s.parse(r.nonce.toLowerCase())["max-age"])||86400},...e,cookieSettings:r}}function g(e,t){return-1===t.toLowerCase().indexOf("domain")?`${t}; Domain=.${e}`:t}function y(e){return e?Object.entries(e).reduce(((e,[t,r])=>Object.assign(e,{[t.toLowerCase()]:[{key:t,value:r}]})),{}):{}}function m(e,t){const r=`CognitoIdentityServiceProvider.${e}`,o=`${r}.LastAuthUser`;let i;return i="string"==typeof t?t:t[o],{lastUserKey:o,userDataKey:`${r}.${i}.userData`,scopeKey:`${r}.${i}.tokenScopesString`,idTokenKey:`${r}.${i}.idToken`,accessTokenKey:`${r}.${i}.accessToken`,refreshTokenKey:`${r}.${i}.refreshToken`}}function k(){return{idTokenKey:"ID-TOKEN",accessTokenKey:"ACCESS-TOKEN",refreshTokenKey:"REFRESH-TOKEN",cognitoEnabledKey:"COGNITO-ENABLED"}}function J(e){const t=S(e.tokens.id_token),r=t["cognito:username"];let o,i;if("amplify"===e.cookieCompatibility){i=m(e.clientId,r);const n=JSON.stringify({UserAttributes:[{Name:"sub",Value:t.sub},{Name:"email",Value:t.email}],Username:r});o={[i.lastUserKey]:`${r}; ${g(e.domainName,e.cookieSettings.idToken)}`,[i.scopeKey]:`${e.oauthScopes.join(" ")}; ${g(e.domainName,e.cookieSettings.accessToken)}`,[i.userDataKey]:`${encodeURIComponent(n)}; ${g(e.domainName,e.cookieSettings.idToken)}`,"amplify-signin-with-hostedUI":`true; ${g(e.domainName,e.cookieSettings.accessToken)}`}}else i={idTokenKey:"ID-TOKEN",accessTokenKey:"ACCESS-TOKEN",refreshTokenKey:"REFRESH-TOKEN",cognitoEnabledKey:"COGNITO-ENABLED"},o={[i.cognitoEnabledKey]:`True; ${g(e.domainName,e.cookieSettings.cognitoEnabled)}`};return Object.assign(o,{[i.idTokenKey]:`${e.tokens.id_token}; ${g(e.domainName,e.cookieSettings.idToken)}`,[i.accessTokenKey]:`${e.tokens.access_token}; ${g(e.domainName,e.cookieSettings.accessToken)}`,[i.refreshTokenKey]:`${e.tokens.refresh_token}; ${g(e.domainName,e.cookieSettings.refreshToken)}`}),"signOut"===e.event?Object.keys(o).forEach((e=>o[e]=v(o[e]))):"refreshFailed"===e.event&&(o[i.refreshTokenKey]=v(o[i.refreshTokenKey])),["spa-auth-edge-nonce","spa-auth-edge-nonce-hmac","spa-auth-edge-pkce"].forEach((e=>{o[e]=v()})),Object.entries({...e.additionalCookies,...o}).map((([e,t])=>({key:"set-cookie",value:`${e}=${t}`})))}function v(e=""){const t=e.split(";").map((e=>e.trim())).filter((e=>!e.toLowerCase().startsWith("max-age"))).filter((e=>!e.toLowerCase().startsWith("expires"))),r=`Expires=${new Date(0).toUTCString()}`,[,...o]=t;return["",...o,r].join("; ")}function S(e){const t=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/");return JSON.parse(Buffer.from(t,"base64").toString())}t.getConfig=h,t.getConfigWithHeaders=w,t.getCompleteConfig=p,t.getConfigWithJwtVerifier=function(){const e=p(),t=e.userPoolArn.split("/")[1];return{...e,jwtVerifier:l.CognitoJwtVerifier.create({userPoolId:t,clientId:e.clientId,tokenUse:"id",groups:e.requiredGroup||void 0})}},t.asCloudFrontHeaders=y,t.getAmplifyCookieNames=m,t.getElasticsearchCookieNames=k,t.extractAndParseCookies=function(e,t,r){const o=function(e){return e.cookie?e.cookie.reduce(((e,t)=>Object.assign(e,s.parse(t.value))),{}):{}}(e);if(!o)return{};let i;return i="amplify"===r?m(t,o):{idTokenKey:"ID-TOKEN",accessTokenKey:"ACCESS-TOKEN",refreshTokenKey:"REFRESH-TOKEN",cognitoEnabledKey:"COGNITO-ENABLED"},{tokenUserName:o[i.lastUserKey],idToken:o[i.idTokenKey],accessToken:o[i.accessTokenKey],refreshToken:o[i.refreshTokenKey],scopes:o[i.scopeKey],nonce:o["spa-auth-edge-nonce"],nonceHmac:o["spa-auth-edge-nonce-hmac"],pkce:o["spa-auth-edge-pkce"]}},t.generateCookieHeaders={newTokens:e=>J({...e,event:"newTokens"}),signOut:e=>J({...e,event:"signOut"}),refreshFailed:e=>J({...e,event:"refreshFailed"})},t.decodeToken=S;const E=new c.Agent({keepAlive:!0});t.httpPostToCognitoWithRetry=async function(e,t,r,o){let i=0;for(;;){++i;try{return await a.fetch(e,t,{agent:E,...r,method:"POST"}).then((e=>{var t;if(200!==e.status)throw new Error(`Status is ${e.status}, expected 200`);if(!(null===(t=e.headers["content-type"])||void 0===t?void 0:t.startsWith("application/json")))throw new Error(`Content-Type is ${e.headers["content-type"]}, expected application/json`);return{...e,data:JSON.parse(e.data.toString())}}))}catch(t){if(o.debug(`HTTP POST to ${e} failed (attempt ${i}):`),o.debug(t.response&&t.response.data||t),i>=5)throw o.error(`No success after ${i} attempts, seizing further attempts`),t;i>=2&&(o.debug("Doing exponential backoff with jitter, before attempting HTTP POST again ..."),await new Promise((e=>setTimeout(e,25*(Math.pow(2,i)+Math.random()*i)))),o.debug("Done waiting, will try HTTP POST again now"))}}},t.createErrorHtml=function(e){const t={...e,region:process.env.AWS_REGION};return d.default.replace(/\${([^}]*)}/g,((e,r)=>{var o;return null!==(o=function(e){if("string"!=typeof e)return;return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}(t[r]))&&void 0!==o?o:""}))},t.urlSafe={stringify:e=>e.replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_"),parse:e=>e.replace(/-/g,"+").replace(/_/g,"/")},t.sign=function(e,r,o){const i=n.createHmac("sha256",r).update(e).digest("base64").slice(0,o);return t.urlSafe.stringify(i)},t.timestampInSeconds=function(){return Date.now()/1e3|0};class b extends Error{}t.RequiresConfirmationError=b},417:e=>{e.exports=require("crypto")},747:e=>{e.exports=require("fs")},211:e=>{e.exports=require("https")},622:e=>{e.exports=require("path")},191:e=>{e.exports=require("querystring")},413:e=>{e.exports=require("stream")},835:e=>{e.exports=require("url")},669:e=>{e.exports=require("util")}},t={};function r(o){var i=t[o];if(void 0!==i)return i.exports;var n=t[o]={exports:{}};return e[o].call(n.exports,n,n.exports,r),n.exports}r.d=(e,t)=>{for(var o in t)r.o(t,o)&&!r.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var o={};(()=>{var e=o;Object.defineProperty(e,"__esModule",{value:!0}),e.handler=void 0;const t=r(191),i=r(326),n=i.getCompleteConfig();n.logger.debug("Configuration loaded:",n);e.handler=async e=>{n.logger.debug("Event:",e);const r=e.Records[0].cf.request,o=r.headers.host[0].value;let s=`https://${o}`;try{const{requestedUri:e,nonce:a}=t.parse(r.querystring);s+=e||"";const{idToken:c,accessToken:d,refreshToken:l,nonce:u,nonceHmac:f}=i.extractAndParseCookies(r.headers,n.clientId,n.cookieCompatibility);!function(e,t,r,o,s,a){if(!r)throw new Error("Your browser didn't send the nonce cookie along, but it is required for security (prevent CSRF).");if(e!==r)throw new Error("Nonce mismatch");Object.entries({idToken:o,accessToken:s,refreshToken:a}).forEach((([e,t])=>{if(!t)throw new Error(`Missing ${e}`)}));const c=parseInt(e.slice(0,e.indexOf("T")));if(i.timestampInSeconds()-c>n.nonceMaxAge)throw new i.RequiresConfirmationError(`Nonce is too old (nonce is from ${new Date(1e3*c).toISOString()})`);const d=i.sign(e,n.nonceSigningSecret,n.nonceLength);if(d!==t)throw new i.RequiresConfirmationError(`Nonce signature mismatch! Expected ${d} but got ${t}`)}(a,f,u,c,d,l);let h={"Content-Type":"application/x-www-form-urlencoded"};if(n.clientSecret){const e=Buffer.from(`${n.clientId}:${n.clientSecret}`).toString("base64");h.Authorization=`Basic ${e}`}let w,p={id_token:c,access_token:d,refresh_token:l};try{const e=t.stringify({grant_type:"refresh_token",client_id:n.clientId,refresh_token:l}),r=await i.httpPostToCognitoWithRetry(`https://${n.cognitoAuthDomain}/oauth2/token`,Buffer.from(e),{headers:h},n.logger).catch((e=>{throw new Error(`Failed to refresh tokens: ${e}`)}));p.id_token=r.data.id_token,p.access_token=r.data.access_token,w="newTokens"}catch(e){w="refreshFailed"}const g={status:"307",statusDescription:"Temporary Redirect",headers:{location:[{key:"location",value:s}],"set-cookie":i.generateCookieHeaders[w]({tokens:p,domainName:o,...n}),...n.cloudFrontHeaders}};return n.logger.debug("Returning response:\n",g),g}catch(e){const t={body:i.createErrorHtml({title:"Refresh issue",message:"We can't refresh your sign-in because of a",expandText:"technical problem",details:`${e}`,linkUri:s,linkText:"Try again"}),status:"200",headers:{...n.cloudFrontHeaders,"content-type":[{key:"Content-Type",value:"text/html; charset=UTF-8"}]}};return n.logger.debug("Returning response:\n",t),t}}})();var i=exports;for(var n in o)i[n]=o[n];o.__esModule&&Object.defineProperty(i,"__esModule",{value:!0})})();