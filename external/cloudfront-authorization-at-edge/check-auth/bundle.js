/*! For license information please see bundle.js.LICENSE.txt */
(()=>{"use strict";var e={932:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.deconstructPublicKeyInDerFormat=t.constructPublicKeyInDerFormat=void 0;const o=r(625);var n,i,s;function a(e){const t=e.class<<7|e.primitiveOrConstructed<<5|e.tag;return Buffer.from([t])}function c(e){if(e<128)return Buffer.from([e]);const t=[];for(;e>0;)t.push(e%256),e>>=8;return t.reverse(),Buffer.from([128|t.length,...t])}function d(e){return Buffer.concat([a({class:n.Universal,primitiveOrConstructed:i.Primitive,tag:s.Integer}),c(e.length),e])}function u(e){const t=Buffer.concat([Buffer.from([0]),e]);return Buffer.concat([a({class:n.Universal,primitiveOrConstructed:i.Primitive,tag:s.BitString}),c(t.length),t])}function l(e){const t=Buffer.concat(e);return Buffer.concat([a({class:n.Universal,primitiveOrConstructed:i.Constructed,tag:s.Sequence}),c(t.length),t])}!function(e){e[e.Universal=0]="Universal"}(n||(n={})),function(e){e[e.Primitive=0]="Primitive",e[e.Constructed=1]="Constructed"}(i||(i={})),function(e){e[e.BitString=3]="BitString",e[e.ObjectIdentifier=6]="ObjectIdentifier",e[e.Sequence=16]="Sequence",e[e.Null=5]="Null",e[e.Integer=2]="Integer"}(s||(s={}));const f=l([function(e){const t=e.split(".").map((e=>parseInt(e))),r=40*t[0]+t[1],o=t.slice(2).reduce(((e,t)=>{const r=[];do{r.push(t%128),t>>=7}while(t);return e.concat(r.map(((e,t)=>t?e+128:e)).reverse())}),[]),d=Buffer.from([r,...o]);return Buffer.concat([a({class:n.Universal,primitiveOrConstructed:i.Primitive,tag:s.ObjectIdentifier}),c(d.length),d])}("1.2.840.113549.1.1.1"),Buffer.concat([a({class:n.Universal,primitiveOrConstructed:i.Primitive,tag:s.Null}),c(0)])]);function h(e){if(e>>3==31)throw new o.Asn1DecodingError("Decoding of identifier with tag > 30 not implemented");return{class:e>>6,primitiveOrConstructed:e>>5&1,tag:31&e}}function p(e){if(!(128&e[0]))return{length:e[0],firstByteOffset:1,lastByteOffset:1+e[0]};const t=127&e[0],r=Buffer.from(e.slice(1,2+t)).readUIntBE(0,t);return{length:r,firstByteOffset:1+t,lastByteOffset:1+t+r}}function w(e){const{tag:t}=h(e[0]);if(t!==s.Sequence)throw new o.Asn1DecodingError(`Expected a sequence to decode, but got tag ${t}`);const{firstByteOffset:r,lastByteOffset:n}=p(e.slice(1)),i=e.slice(1+r,2+n),a=[];let c=0;for(;c<i.length;){const e=h(i[c]),t=p(i.slice(c+1)),r=i.slice(c+1+t.firstByteOffset,c+1+t.lastByteOffset);a.push({identifier:e,length:t.length,value:r}),c+=1+t.lastByteOffset}return a}t.constructPublicKeyInDerFormat=function(e,t){return l([f,u(l([d(e),d(t)]))])},t.deconstructPublicKeyInDerFormat=function(e){const[,t]=w(e),[r,o]=w(t.value.slice(1));return{n:r.value,e:o.value}}},707:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.assertStringArraysOverlap=t.assertStringArrayContainsString=t.assertStringEquals=void 0;const o=r(625);function n(e,t,r){if(!t)throw new o.AssertionError(`Missing ${e}. ${i(r)}`);const n=new Set(Array.isArray(r)?r:[r]);if("string"==typeof t&&(t=[t]),!Array.isArray(t))throw new o.AssertionError(`${e} is not an array`);if(!t.some((t=>{if("string"!=typeof t)throw new o.AssertionError(`${e} includes elements that are not of type string`);return n.has(t)})))throw new o.AssertionError(`${e} not allowed: ${t.join(", ")}. ${i(r)}`)}function i(e){return Array.isArray(e)?e.length>1?`Expected one of: ${e.join(", ")}`:`Expected: ${e[0]}`:`Expected: ${e}`}t.assertStringEquals=function(e,t,r){if(!t)throw new o.AssertionError(`Missing ${e}. Expected: ${r}`);if("string"!=typeof t)throw new o.AssertionError(`${e} is not of type string`);if(r!==t)throw new o.AssertionError(`${e} not allowed: ${t}. Expected: ${r}`)},t.assertStringArrayContainsString=function(e,t,r){if(!t)throw new o.AssertionError(`Missing ${e}. ${i(r)}`);if("string"!=typeof t)throw new o.AssertionError(`${e} is not of type string`);return n(e,t,r)},t.assertStringArraysOverlap=n},253:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.CognitoJwtVerifier=void 0;const o=r(625),n=r(999),i=r(707);function s(e,t){if(null!=t.groups&&(0,i.assertStringArraysOverlap)("Cognito group",e["cognito:groups"],t.groups),(0,i.assertStringArrayContainsString)("Token use",e.token_use,["id","access"]),null!==t.tokenUse){if(void 0===t.tokenUse)throw new o.ParameterValidationError("tokenUse must be provided or set to null explicitly");(0,i.assertStringEquals)("Token use",e.token_use,t.tokenUse)}if(null!==t.clientId){if(void 0===t.clientId)throw new o.ParameterValidationError("clientId must be provided or set to null explicitly");"id"===e.token_use?(0,i.assertStringArrayContainsString)('Client ID ("audience")',e.aud,t.clientId):(0,i.assertStringArrayContainsString)("Client ID",e.client_id,t.clientId)}}class a extends n.JwtRsaVerifierBase{constructor(e,t){super(Array.isArray(e)?e.map((e=>({...e,...a.parseUserPoolId(e.userPoolId),audience:null}))):{...e,...a.parseUserPoolId(e.userPoolId),audience:null},t)}static parseUserPoolId(e){const t=e.match(/^(?<region>(\w+-)?\w+-\w+-\d)+_\w+$/);if(!t)throw new o.ParameterValidationError(`Invalid Cognito User Pool ID: ${e}`);const r=`https://cognito-idp.${t.groups.region}.amazonaws.com/${e}`;return{issuer:r,jwksUri:`${r}/.well-known/jwks.json`}}static create(e,t){return new this(e,t?.jwksCache)}verifySync(...e){const t=super.verifySync(...e);return s(t,{...this.getIssuerConfig(t.iss),...e[1]}),t}async verify(...e){const t=await super.verify(...e);return s(t,{...this.getIssuerConfig(t.iss),...e[1]}),t}cacheJwks(...e){let t;if(void 0!==e[1])t=a.parseUserPoolId(e[1]).issuer;else if(this.expectedIssuers.length>1)throw new o.ParameterValidationError("userPoolId must be provided");const r=this.getIssuerConfig(t);super.cacheJwks(e[0],r.issuer)}}t.CognitoJwtVerifier=a},625:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.AssertionError=t.NonRetryableFetchError=t.FetchError=t.JwksNotAvailableInCacheError=t.WaitPeriodNotYetEndedJwkError=t.KidNotFoundInJwksError=t.JwtWithoutValidKidError=t.JwkValidationError=t.JwksValidationError=t.Asn1DecodingError=t.JwtInvalidClaimError=t.ParameterValidationError=t.JwtNotBeforeError=t.JwtExpiredError=t.JwtInvalidSignatureError=t.JwtParseError=t.JwtBaseError=void 0;class r extends Error{}t.JwtBaseError=r;t.JwtParseError=class extends r{constructor(e,t){super(null!=t?`${e}: ${t}`:e)}};t.JwtInvalidSignatureError=class extends r{};t.JwtExpiredError=class extends r{};t.JwtNotBeforeError=class extends r{};t.ParameterValidationError=class extends r{};t.JwtInvalidClaimError=class extends r{};t.Asn1DecodingError=class extends r{};t.JwksValidationError=class extends r{};t.JwkValidationError=class extends r{};t.JwtWithoutValidKidError=class extends r{};t.KidNotFoundInJwksError=class extends r{};t.WaitPeriodNotYetEndedJwkError=class extends r{};t.JwksNotAvailableInCacheError=class extends r{};class o extends r{constructor(e,t){super(`Failed to fetch ${e}: ${t}`)}}t.FetchError=o;t.NonRetryableFetchError=class extends o{};t.AssertionError=class extends r{}},829:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.fetchJson=t.SimpleJsonFetcher=void 0;const o=r(211),n=r(413),i=r(669),s=r(784),a=r(625);async function c(e,t,r){let i;return new Promise(((s,c)=>{const u=(0,o.request)(e,{method:"GET",...t},(t=>{n.pipeline([t,d(e,t.statusCode,t.headers)],l)}));function l(...t){if(i&&clearTimeout(i),null==t[0])return void s(t[1]);u.socket?.emit("agentRemove");let r=t[0];r instanceof a.FetchError||(r=new a.FetchError(e,r.message)),u.destroy(),c(r)}t?.responseTimeout&&(i=setTimeout((()=>l(new a.FetchError(e,`Response time-out (after ${t.responseTimeout} ms.)`))),t.responseTimeout),i.unref()),u.on("error",l),u.end(r)}))}function d(e,t,r){return async o=>{if(429===t)throw new a.FetchError(e,"Too many requests");if(200!==t)throw new a.NonRetryableFetchError(e,`Status code is ${t}, expected 200`);if(!r["content-type"]?.toLowerCase().startsWith("application/json"))throw new a.NonRetryableFetchError(e,`Content-type is "${r["content-type"]}", expected "application/json"`);const n=[];for await(const e of o)n.push(e);try{return(0,s.safeJsonParse)(new i.TextDecoder("utf8",{fatal:!0,ignoreBOM:!0}).decode(Buffer.concat(n)))}catch(t){throw new a.NonRetryableFetchError(e,t)}}}t.SimpleJsonFetcher=class{constructor(e){this.defaultRequestOptions={timeout:500,responseTimeout:1500,...e?.defaultRequestOptions}}async fetch(e,t,r){t={...this.defaultRequestOptions,...t};try{return await c(e,t,r)}catch(o){if(o instanceof a.NonRetryableFetchError)throw o;return c(e,t,r)}}},t.fetchJson=c},48:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.CognitoJwtVerifier=t.JwtRsaVerifier=void 0;var o=r(999);Object.defineProperty(t,"JwtRsaVerifier",{enumerable:!0,get:function(){return o.JwtRsaVerifier}});var n=r(253);Object.defineProperty(t,"CognitoJwtVerifier",{enumerable:!0,get:function(){return n.CognitoJwtVerifier}})},308:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.SimpleJwksCache=t.SimplePenaltyBox=t.isJwk=t.isJwks=t.assertIsJwk=t.assertIsJwks=t.fetchJwk=t.fetchJwks=void 0;const o=r(829),n=r(784),i=r(625),s=["alg","e","kid","kty","n","use"];async function a(e){const t=await(0,o.fetchJson)(e);return c(t),t}function c(e){if(!e)throw new i.JwksValidationError("JWKS empty");if(!(0,n.isJsonObject)(e))throw new i.JwksValidationError("JWKS should be an object");if(!Object.keys(e).includes("keys"))throw new i.JwksValidationError("JWKS does not include keys");if(!Array.isArray(e.keys))throw new i.JwksValidationError("JWKS keys should be an array");for(const t of e.keys)d(t)}function d(e){if(!e)throw new i.JwkValidationError("JWK empty");if(!(0,n.isJsonObject)(e))throw new i.JwkValidationError("JWK should be an object");for(const t of s)if(!(t in e))throw new i.JwkValidationError(`JWK ${t} should be a string`)}t.fetchJwks=a,t.fetchJwk=async function(e,t){if(!t.header.kid)throw new i.JwtWithoutValidKidError("JWT header does not have valid kid claim");const r=(await a(e)).keys.find((e=>e.kid===t.header.kid));if(!r)throw new i.KidNotFoundInJwksError(`JWK for kid "${t.header.kid}" not found in the JWKS`);return r},t.assertIsJwks=c,t.assertIsJwk=d,t.isJwks=function(e){try{return c(e),!0}catch{return!1}},t.isJwk=function(e){try{return d(e),!0}catch{return!1}};class u{constructor(e){this.waitingUris=new Map,this.waitSeconds=e?.waitSeconds??10}async wait(e){if(this.waitingUris.has(e))throw new i.WaitPeriodNotYetEndedJwkError("Not allowed to fetch JWKS yet, still waiting for back off period to end")}release(e){const t=this.waitingUris.get(e);t&&(clearTimeout(t),this.waitingUris.delete(e))}registerFailedAttempt(e){const t=setTimeout((()=>{this.waitingUris.delete(e)}),1e3*this.waitSeconds).unref();this.waitingUris.set(e,t)}registerSuccessfulAttempt(e){this.release(e)}}t.SimplePenaltyBox=u;t.SimpleJwksCache=class{constructor(e){this.jwksCache=new Map,this.fetchingJwks=new Map,this.penaltyBox=e?.penaltyBox??new u,this.fetcher=e?.fetcher??new o.SimpleJsonFetcher}addJwks(e,t){this.jwksCache.set(e,t)}async getJwks(e){const t=this.fetchingJwks.get(e);if(t)return t;const r=this.fetcher.fetch(e).then((e=>(c(e),e)));let o;this.fetchingJwks.set(e,r);try{o=await r}finally{this.fetchingJwks.delete(e)}return this.jwksCache.set(e,o),o}getCachedJwk(e,t){if("string"!=typeof t.header.kid)throw new i.JwtWithoutValidKidError("JWT header does not have valid kid claim");if(!this.jwksCache.has(e))throw new i.JwksNotAvailableInCacheError(`JWKS for uri ${e} not yet available in cache`);const r=this.jwksCache.get(e).keys.find((e=>e.kid===t.header.kid));if(!r)throw new i.KidNotFoundInJwksError(`JWK for kid ${t.header.kid} not found in the JWKS`);return r}async getJwk(e,t){if("string"!=typeof t.header.kid)throw new i.JwtWithoutValidKidError("JWT header does not have valid kid claim");let r=this.jwksCache.get(e)?.keys.find((e=>e.kid===t.header.kid));if(r)return r;await this.penaltyBox.wait(e,t.header.kid);if(r=(await this.getJwks(e)).keys.find((e=>e.kid===t.header.kid)),!r)throw this.penaltyBox.registerFailedAttempt(e,t.header.kid),new i.KidNotFoundInJwksError(`JWK for kid "${t.header.kid}" not found in the JWKS`);return this.penaltyBox.registerSuccessfulAttempt(e,t.header.kid),r}}},999:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.KeyObjectCache=t.transformJwkToKeyObject=t.JwtRsaVerifier=t.JwtRsaVerifierBase=t.verifyJwtSync=t.verifyJwt=void 0;const o=r(417),n=r(835),i=r(622),s=r(308),a=r(932),c=r(707),d=r(403),u=r(625);function l(e,r,n,i,s,a,d=t.transformJwkToKeyObject){(0,c.assertStringEquals)("JWK use",a.use,"sig"),(0,c.assertStringEquals)("JWT signature algorithm",e.alg,a.alg),(0,c.assertStringEquals)("JWT signature algorithm",e.alg,"RS256");const l=d(a,n.iss,e.kid);if(!(0,o.createVerify)("RSA-SHA256").update(`${r}.${i}`).verify(l,s,"base64"))throw new u.JwtInvalidSignatureError("Invalid signature")}async function f(e,t,r,o=s.fetchJwk,n){const{header:i,headerB64:a,payload:c,payloadB64:u,signatureB64:f}=e;(0,d.validateJwtFields)(c,r);const h=await o(t,e);return l(i,a,c,u,f,h,n),r.customJwtCheck&&await r.customJwtCheck({header:i,payload:c,jwk:h}),c}function h(e,t,r,o){const{header:n,headerB64:i,payload:a,payloadB64:c,signatureB64:f}=e;let h;if((0,d.validateJwtFields)(a,r),(0,s.isJwk)(t))h=t;else{if(!(0,s.isJwks)(t))throw new u.ParameterValidationError([`Expected a valid JWK or JWKS (parsed as JavaScript object), but received: ${t}.`,"If you're passing a JWKS URI, use the async verify() method instead, it will download and parse the JWKS for you"].join());{const e=t.keys.find((e=>e.kid===n.kid));if(!e)throw new u.KidNotFoundInJwksError(`JWK for kid ${n.kid} not found in the JWKS`);h=e}}if(l(n,i,a,c,f,h,o),r.customJwtCheck){const e=r.customJwtCheck({header:n,payload:a,jwk:h});if(void 0!==e&&e instanceof Promise)throw new u.ParameterValidationError("Custom JWT checks must be synchronous but a promise was returned")}return a}t.verifyJwt=async function(e,t,r,o,n){return f((0,d.decomposeJwt)(e),t,r,o,n)},t.verifyJwtSync=function(e,t,r,o){return h((0,d.decomposeJwt)(e),t,r,o)};class p{constructor(e,t=new s.SimpleJwksCache){if(this.jwksCache=t,this.issuersConfig=new Map,this.publicKeyCache=new w,Array.isArray(e)){if(!e.length)throw new u.ParameterValidationError("Provide at least one issuer configuration");for(const t of e){if(this.issuersConfig.has(t.issuer))throw new u.ParameterValidationError(`issuer ${t.issuer} supplied multiple times`);this.issuersConfig.set(t.issuer,this.withJwksUri(t))}}else this.issuersConfig.set(e.issuer,this.withJwksUri(e))}get expectedIssuers(){return Array.from(this.issuersConfig.keys())}getIssuerConfig(e){if(!e){if(1!==this.issuersConfig.size)throw new u.ParameterValidationError("issuer must be provided");e=this.issuersConfig.keys().next().value}const t=this.issuersConfig.get(e);if(!t)throw new u.ParameterValidationError(`issuer not configured: ${e}`);return t}cacheJwks(...e){const t=this.getIssuerConfig(e[1]);this.jwksCache.addJwks(t.jwksUri,e[0]),this.publicKeyCache.clearCache(t.issuer)}async hydrate(){const e=this.expectedIssuers.map((e=>this.getIssuerConfig(e).jwksUri)).map((e=>this.jwksCache.getJwks(e)));await Promise.all(e)}verifySync(...e){const{decomposedJwt:t,jwksUri:r,verifyProperties:o}=this.getVerifyParameters(e[0],e[1]);return h(t,this.jwksCache.getCachedJwk(r,t),o,this.publicKeyCache.transformJwkToKeyObject.bind(this.publicKeyCache))}async verify(...e){const{decomposedJwt:t,jwksUri:r,verifyProperties:o}=this.getVerifyParameters(e[0],e[1]);return f(t,r,o,this.jwksCache.getJwk.bind(this.jwksCache),this.publicKeyCache.transformJwkToKeyObject.bind(this.publicKeyCache))}getVerifyParameters(e,t){const r=(0,d.decomposeJwt)(e);if(!r.payload.iss)throw new u.JwtInvalidClaimError("JWT payload does not have iss claim");(0,c.assertStringArrayContainsString)("Issuer",r.payload.iss,this.expectedIssuers);const o=this.getIssuerConfig(r.payload.iss);return{decomposedJwt:r,jwksUri:o.jwksUri,verifyProperties:{...o,...t}}}withJwksUri(e){if(e.jwksUri)return e;const t=new n.URL(e.issuer);return{jwksUri:new n.URL((0,i.join)(t.pathname,"/.well-known/jwks.json"),e.issuer).href,...e}}}t.JwtRsaVerifierBase=p;t.JwtRsaVerifier=class extends p{static create(e,t){return new this(e,t?.jwksCache)}};t.transformJwkToKeyObject=e=>(0,o.createPublicKey)({key:(0,a.constructPublicKeyInDerFormat)(Buffer.from(e.n,"base64"),Buffer.from(e.e,"base64")),format:"der",type:"spki"});class w{constructor(e=t.transformJwkToKeyObject){this.jwkToKeyObjectTransformer=e,this.publicKeys=new Map}transformJwkToKeyObject(e,t){if(!t)return this.jwkToKeyObjectTransformer(e);const r=this.publicKeys.get(t)?.get(e.kid);if(r)return r;const o=this.jwkToKeyObjectTransformer(e),n=this.publicKeys.get(t);return n?n.set(e.kid,o):this.publicKeys.set(t,new Map([[e.kid,o]])),o}clearCache(e){this.publicKeys.delete(e)}}t.KeyObjectCache=w},403:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.validateJwtFields=t.decomposeJwt=void 0;const o=r(707),n=r(784),i=r(625);t.decomposeJwt=function(e){if(!e)throw new i.JwtParseError("Empty JWT");if("string"!=typeof e)throw new i.JwtParseError("JWT is not a string");if(!e.match(/^[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+$/))throw new i.JwtParseError("JWT string does not consist of exactly 3 parts (header, payload, signature)");const[t,r,o]=e.split("."),[s,a]=[t,r].map((e=>Buffer.from(e,"base64").toString("utf8")));let c,d;try{c=(0,n.safeJsonParse)(s)}catch(e){throw new i.JwtParseError("Invalid JWT. Header is not a valid JSON object",e)}!function(e){if(!(0,n.isJsonObject)(e))throw new i.JwtParseError("JWT header is not an object");if(void 0!==e.alg&&"string"!=typeof e.alg)throw new i.JwtParseError("JWT header alg claim is not a string");if(void 0!==e.kid&&"string"!=typeof e.kid)throw new i.JwtParseError("JWT header kid claim is not a string")}(c);try{d=(0,n.safeJsonParse)(a)}catch(e){throw new i.JwtParseError("Invalid JWT. Payload is not a valid JSON object",e)}return function(e){if(!(0,n.isJsonObject)(e))throw new i.JwtParseError("JWT payload is not an object");if(void 0!==e.exp&&!Number.isFinite(e.exp))throw new i.JwtParseError("JWT payload exp claim is not a number");if(void 0!==e.iss&&"string"!=typeof e.iss)throw new i.JwtParseError("JWT payload iss claim is not a string");if(void 0!==e.aud&&"string"!=typeof e.aud&&(!Array.isArray(e.aud)||e.aud.some((e=>"string"!=typeof e))))throw new i.JwtParseError("JWT payload aud claim is not a string or array of strings");if(void 0!==e.nbf&&!Number.isFinite(e.nbf))throw new i.JwtParseError("JWT payload nbf claim is not a number");if(void 0!==e.iat&&!Number.isFinite(e.iat))throw new i.JwtParseError("JWT payload iat claim is not a number");if(void 0!==e.scope&&"string"!=typeof e.scope)throw new i.JwtParseError("JWT payload scope claim is not a string");if(void 0!==e.jti&&"string"!=typeof e.jti)throw new i.JwtParseError("JWT payload jti claim is not a string")}(d),{header:c,headerB64:t,payload:d,payloadB64:r,signatureB64:o}},t.validateJwtFields=function(e,t){if(void 0!==e.exp&&e.exp+(t.graceSeconds??0)<Date.now()/1e3)throw new i.JwtExpiredError(`Token expired at ${new Date(1e3*e.exp).toISOString()}`);if(void 0!==e.nbf&&e.nbf-(t.graceSeconds??0)>Date.now()/1e3)throw new i.JwtNotBeforeError(`Token can't be used before ${new Date(1e3*e.nbf).toISOString()}`);if(null!==t.issuer){if(void 0===t.issuer)throw new i.ParameterValidationError("issuer must be provided or set to null explicitly");(0,o.assertStringArrayContainsString)("Issuer",e.iss,t.issuer)}if(null!==t.audience){if(void 0===t.audience)throw new i.ParameterValidationError("audience must be provided or set to null explicitly");(0,o.assertStringArraysOverlap)("Audience",e.aud,t.audience)}null!=t.scope&&(0,o.assertStringArraysOverlap)("Scope",e.scope?.split(" "),t.scope)}},784:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.safeJsonParse=t.isJsonObject=void 0,t.isJsonObject=function(e){return"object"==typeof e&&!Array.isArray(e)&&null!==e},t.safeJsonParse=function(e){return JSON.parse(e,((e,t)=>("object"!=typeof t||Array.isArray(t)||null===t||(delete t.__proto__,delete t.constructor),t)))}},489:(e,t)=>{t.parse=function(e,t){if("string"!=typeof e)throw new TypeError("argument str must be a string");for(var o={},i=t||{},a=e.split(n),c=i.decode||r,d=0;d<a.length;d++){var u=a[d],l=u.indexOf("=");if(!(l<0)){var f=u.substr(0,l).trim(),h=u.substr(++l,u.length).trim();'"'==h[0]&&(h=h.slice(1,-1)),null==o[f]&&(o[f]=s(h,c))}}return o},t.serialize=function(e,t,r){var n=r||{},s=n.encode||o;if("function"!=typeof s)throw new TypeError("option encode is invalid");if(!i.test(e))throw new TypeError("argument name is invalid");var a=s(t);if(a&&!i.test(a))throw new TypeError("argument val is invalid");var c=e+"="+a;if(null!=n.maxAge){var d=n.maxAge-0;if(isNaN(d)||!isFinite(d))throw new TypeError("option maxAge is invalid");c+="; Max-Age="+Math.floor(d)}if(n.domain){if(!i.test(n.domain))throw new TypeError("option domain is invalid");c+="; Domain="+n.domain}if(n.path){if(!i.test(n.path))throw new TypeError("option path is invalid");c+="; Path="+n.path}if(n.expires){if("function"!=typeof n.expires.toUTCString)throw new TypeError("option expires is invalid");c+="; Expires="+n.expires.toUTCString()}n.httpOnly&&(c+="; HttpOnly");n.secure&&(c+="; Secure");if(n.sameSite){switch("string"==typeof n.sameSite?n.sameSite.toLowerCase():n.sameSite){case!0:c+="; SameSite=Strict";break;case"lax":c+="; SameSite=Lax";break;case"strict":c+="; SameSite=Strict";break;case"none":c+="; SameSite=None";break;default:throw new TypeError("option sameSite is invalid")}}return c};var r=decodeURIComponent,o=encodeURIComponent,n=/; */,i=/^[\u0009\u0020-\u007e\u0080-\u00ff]+$/;function s(e,t){try{return t(e)}catch(t){return e}}},846:(e,t,r)=>{r.r(t),r.d(t,{default:()=>o});const o='<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"/> <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"/> <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous"/> <title>Authorization@Edge</title> <style>html{padding:0}body{display:flex;min-height:100%;margin:0;justify-content:center;align-items:flex-start}.message-card{flex-grow:1;max-width:600px;margin-top:2%}</style> </head> <body> <div class="card message-card"> <h5 class="card-header">Authorization@Edge</h5> <div class="card-body"> <h5 class="card-title">${title}</h5> <p> ${message} <a class="card-link" data-toggle="collapse" href="#details" role="button" aria-expanded="false" aria-controls="details"> ${expandText} </a> </p> <p class="collapse blockquote-footer" id="details"> ${details} [log region: ${region}] </p> <a href="${linkUri}" class="btn btn-primary" role="button">${linkText}</a> </div> </div> <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"><\/script> <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"><\/script> </body> </html> '},910:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.fetch=void 0;const o=r(211),n=r(413);t.fetch=async function(e,t,r){return new Promise(((s,a)=>{const c=o.request(e,null!=r?r:{},(e=>n.pipeline([e,i((t=>s({status:e.statusCode,headers:e.headers,data:t})))],d)));function d(e){e&&(c.destroy(e),a(e))}c.on("error",d),c.end(t)}))};const i=e=>{const t=[];return new n.Writable({write:(e,r,o)=>{try{t.push(e),o()}catch(e){o(e)}},final:r=>{try{e(Buffer.concat(t)),r()}catch(e){r(e)}}})}},326:function(e,t,r){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.RequiresConfirmationError=t.timestampInSeconds=t.sign=t.urlSafe=t.createErrorHtml=t.httpPostToCognitoWithRetry=t.decodeToken=t.generateCookieHeaders=t.extractAndParseCookies=t.getElasticsearchCookieNames=t.getAmplifyCookieNames=t.asCloudFrontHeaders=t.getConfigWithJwtVerifier=t.getCompleteConfig=t.getConfigWithHeaders=t.getConfig=void 0;const n=r(747),i=r(417),s=r(489),a=r(910),c=r(211),d=o(r(846)),u=r(48);var l;!function(e){e[e.none=0]="none",e[e.error=10]="error",e[e.warn=20]="warn",e[e.info=30]="info",e[e.debug=40]="debug"}(l||(l={}));class f{constructor(e){this.logLevel=e}jsonify(e){return e.map((e=>{if("object"==typeof e)try{return JSON.stringify(e)}catch{return e}return e}))}info(...e){this.logLevel>=l.info&&console.log(...this.jsonify(e))}warn(...e){this.logLevel>=l.warn&&console.warn(...this.jsonify(e))}error(...e){this.logLevel>=l.error&&console.error(...this.jsonify(e))}debug(...e){this.logLevel>=l.debug&&console.trace(...this.jsonify(e))}}function h(){const e=JSON.parse(n.readFileSync(`${__dirname}/configuration.json`).toString("utf8"));return{logger:new f(l[e.logLevel]),...e}}function p(){const e=h();if(!function(e){return void 0!==e.httpHeaders}(e))throw new Error("Incomplete config in configuration.json");return{cloudFrontHeaders:y(e.httpHeaders),...e}}function w(){const e=p();if(!function(e){return void 0!==e.userPoolArn}(e))throw new Error("Incomplete config in configuration.json");const t=function(e){if("amplify"===e.compatibility){if("spaMode"===e.mode)return{idToken:"Path=/; Secure; SameSite=Lax",accessToken:"Path=/; Secure; SameSite=Lax",refreshToken:"Path=/; Secure; SameSite=Lax",nonce:"Path=/; Secure; HttpOnly; SameSite=Lax"};if("staticSiteMode"===e.mode)return{idToken:"Path=/; Secure; HttpOnly; SameSite=Lax",accessToken:"Path=/; Secure; HttpOnly; SameSite=Lax",refreshToken:"Path=/; Secure; HttpOnly; SameSite=Lax",nonce:"Path=/; Secure; HttpOnly; SameSite=Lax"}}else if("elasticsearch"===e.compatibility)return{idToken:"Path=/; Secure; HttpOnly; SameSite=Lax",accessToken:"Path=/; Secure; HttpOnly; SameSite=Lax",refreshToken:"Path=/; Secure; HttpOnly; SameSite=Lax",nonce:"Path=/; Secure; HttpOnly; SameSite=Lax",cognitoEnabled:"Path=/; Secure; SameSite=Lax"};throw new Error(`Cannot determine default cookiesettings for ${e.mode} with compatibility ${e.compatibility}`)}({compatibility:e.cookieCompatibility,mode:e.mode}),r=e.cookieSettings?Object.fromEntries(Object.entries({...t,...e.cookieSettings}).map((([e,r])=>[e,r||t[e]]))):t;return{...{secretAllowedCharacters:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",pkceLength:43,nonceLength:16,nonceMaxAge:(null==r?void 0:r.nonce)&&parseInt(s.parse(r.nonce.toLowerCase())["max-age"])||86400},...e,cookieSettings:r}}function g(e,t){return-1===t.toLowerCase().indexOf("domain")?`${t}; Domain=.${e}`:t}function y(e){return e?Object.entries(e).reduce(((e,[t,r])=>Object.assign(e,{[t.toLowerCase()]:[{key:t,value:r}]})),{}):{}}function m(e,t){const r=`CognitoIdentityServiceProvider.${e}`,o=`${r}.LastAuthUser`;let n;return n="string"==typeof t?t:t[o],{lastUserKey:o,userDataKey:`${r}.${n}.userData`,scopeKey:`${r}.${n}.tokenScopesString`,idTokenKey:`${r}.${n}.idToken`,accessTokenKey:`${r}.${n}.accessToken`,refreshTokenKey:`${r}.${n}.refreshToken`}}function k(){return{idTokenKey:"ID-TOKEN",accessTokenKey:"ACCESS-TOKEN",refreshTokenKey:"REFRESH-TOKEN",cognitoEnabledKey:"COGNITO-ENABLED"}}function J(e){const t=v(e.tokens.id_token),r=t["cognito:username"];let o,n;if("amplify"===e.cookieCompatibility){n=m(e.clientId,r);const i=JSON.stringify({UserAttributes:[{Name:"sub",Value:t.sub},{Name:"email",Value:t.email}],Username:r});o={[n.lastUserKey]:`${r}; ${g(e.domainName,e.cookieSettings.idToken)}`,[n.scopeKey]:`${e.oauthScopes.join(" ")}; ${g(e.domainName,e.cookieSettings.accessToken)}`,[n.userDataKey]:`${encodeURIComponent(i)}; ${g(e.domainName,e.cookieSettings.idToken)}`,"amplify-signin-with-hostedUI":`true; ${g(e.domainName,e.cookieSettings.accessToken)}`}}else n={idTokenKey:"ID-TOKEN",accessTokenKey:"ACCESS-TOKEN",refreshTokenKey:"REFRESH-TOKEN",cognitoEnabledKey:"COGNITO-ENABLED"},o={[n.cognitoEnabledKey]:`True; ${g(e.domainName,e.cookieSettings.cognitoEnabled)}`};return Object.assign(o,{[n.idTokenKey]:`${e.tokens.id_token}; ${g(e.domainName,e.cookieSettings.idToken)}`,[n.accessTokenKey]:`${e.tokens.access_token}; ${g(e.domainName,e.cookieSettings.accessToken)}`,[n.refreshTokenKey]:`${e.tokens.refresh_token}; ${g(e.domainName,e.cookieSettings.refreshToken)}`}),"signOut"===e.event?Object.keys(o).forEach((e=>o[e]=S(o[e]))):"refreshFailed"===e.event&&(o[n.refreshTokenKey]=S(o[n.refreshTokenKey])),["spa-auth-edge-nonce","spa-auth-edge-nonce-hmac","spa-auth-edge-pkce"].forEach((e=>{o[e]=S()})),Object.entries({...e.additionalCookies,...o}).map((([e,t])=>({key:"set-cookie",value:`${e}=${t}`})))}function S(e=""){const t=e.split(";").map((e=>e.trim())).filter((e=>!e.toLowerCase().startsWith("max-age"))).filter((e=>!e.toLowerCase().startsWith("expires"))),r=`Expires=${new Date(0).toUTCString()}`,[,...o]=t;return["",...o,r].join("; ")}function v(e){const t=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/");return JSON.parse(Buffer.from(t,"base64").toString())}t.getConfig=h,t.getConfigWithHeaders=p,t.getCompleteConfig=w,t.getConfigWithJwtVerifier=function(){const e=w(),t=e.userPoolArn.split("/")[1];return{...e,jwtVerifier:u.CognitoJwtVerifier.create({userPoolId:t,clientId:e.clientId,tokenUse:"id",groups:e.requiredGroup||void 0})}},t.asCloudFrontHeaders=y,t.getAmplifyCookieNames=m,t.getElasticsearchCookieNames=k,t.extractAndParseCookies=function(e,t,r){const o=function(e){return e.cookie?e.cookie.reduce(((e,t)=>Object.assign(e,s.parse(t.value))),{}):{}}(e);if(!o)return{};let n;return n="amplify"===r?m(t,o):{idTokenKey:"ID-TOKEN",accessTokenKey:"ACCESS-TOKEN",refreshTokenKey:"REFRESH-TOKEN",cognitoEnabledKey:"COGNITO-ENABLED"},{tokenUserName:o[n.lastUserKey],idToken:o[n.idTokenKey],accessToken:o[n.accessTokenKey],refreshToken:o[n.refreshTokenKey],scopes:o[n.scopeKey],nonce:o["spa-auth-edge-nonce"],nonceHmac:o["spa-auth-edge-nonce-hmac"],pkce:o["spa-auth-edge-pkce"]}},t.generateCookieHeaders={newTokens:e=>J({...e,event:"newTokens"}),signOut:e=>J({...e,event:"signOut"}),refreshFailed:e=>J({...e,event:"refreshFailed"})},t.decodeToken=v;const b=new c.Agent({keepAlive:!0});t.httpPostToCognitoWithRetry=async function(e,t,r,o){let n=0;for(;;){++n;try{return await a.fetch(e,t,{agent:b,...r,method:"POST"}).then((e=>{var t;if(200!==e.status)throw new Error(`Status is ${e.status}, expected 200`);if(!(null===(t=e.headers["content-type"])||void 0===t?void 0:t.startsWith("application/json")))throw new Error(`Content-Type is ${e.headers["content-type"]}, expected application/json`);return{...e,data:JSON.parse(e.data.toString())}}))}catch(t){if(o.debug(`HTTP POST to ${e} failed (attempt ${n}):`),o.debug(t.response&&t.response.data||t),n>=5)throw o.error(`No success after ${n} attempts, seizing further attempts`),t;n>=2&&(o.debug("Doing exponential backoff with jitter, before attempting HTTP POST again ..."),await new Promise((e=>setTimeout(e,25*(Math.pow(2,n)+Math.random()*n)))),o.debug("Done waiting, will try HTTP POST again now"))}}},t.createErrorHtml=function(e){const t={...e,region:process.env.AWS_REGION};return d.default.replace(/\${([^}]*)}/g,((e,r)=>{var o;return null!==(o=function(e){if("string"!=typeof e)return;return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}(t[r]))&&void 0!==o?o:""}))},t.urlSafe={stringify:e=>e.replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_"),parse:e=>e.replace(/-/g,"+").replace(/_/g,"/")},t.sign=function(e,r,o){const n=i.createHmac("sha256",r).update(e).digest("base64").slice(0,o);return t.urlSafe.stringify(n)},t.timestampInSeconds=function(){return Date.now()/1e3|0};class E extends Error{}t.RequiresConfirmationError=E},417:e=>{e.exports=require("crypto")},747:e=>{e.exports=require("fs")},211:e=>{e.exports=require("https")},622:e=>{e.exports=require("path")},191:e=>{e.exports=require("querystring")},413:e=>{e.exports=require("stream")},835:e=>{e.exports=require("url")},669:e=>{e.exports=require("util")}},t={};function r(o){var n=t[o];if(void 0!==n)return n.exports;var i=t[o]={exports:{}};return e[o].call(i.exports,i,i.exports,r),i.exports}r.d=(e,t)=>{for(var o in t)r.o(t,o)&&!r.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var o={};(()=>{var e=o;Object.defineProperty(e,"__esModule",{value:!0}),e.handler=void 0;const t=r(191),n=r(417),i=r(326),s=i.getConfigWithJwtVerifier();s.logger.debug("Configuration loaded:",s);function a(e){e||(e=[...new Array(s.pkceLength)].map((()=>d(s.secretAllowedCharacters))).join(""));const t={pkce:e,pkceHash:i.urlSafe.stringify(n.createHash("sha256").update(e,"utf8").digest("base64"))};return s.logger.debug("Generated PKCE verifier:\n",t),t}function c(){const e=[...new Array(s.nonceLength)].map((()=>d(s.secretAllowedCharacters))).join(""),t=`${i.timestampInSeconds()}T${e}`;return s.logger.debug("Generated new nonce:",t),t}function d(e){if(e.length>256)throw new Error(`indexable is too large: ${e.length}`);const t=Math.floor(256/e.length),r=e.length*t;let o;do{o=n.randomBytes(1)[0]}while(o>=r);return e[o%e.length]}e.handler=async e=>{s.logger.debug("Event:",e);const r=e.Records[0].cf.request,o=r.headers.host[0].value,n=`${r.uri}${r.querystring?"?"+r.querystring:""}`;try{const{idToken:e,refreshToken:a,nonce:d,nonceHmac:u}=i.extractAndParseCookies(r.headers,s.clientId,s.cookieCompatibility);if(s.logger.debug("Extracted cookies:\n",{idToken:e,refreshToken:a,nonce:d,nonceHmac:u}),!e)throw new Error("No ID token present in cookies");const{exp:l}=i.decodeToken(e);if(s.logger.debug("ID token exp:",l,new Date(1e3*l).toISOString()),Date.now()/1e3>l-600&&a){s.logger.info("Will redirect to refresh endpoint for refreshing tokens using refresh token");const e=c(),r={status:"307",statusDescription:"Temporary Redirect",headers:{location:[{key:"location",value:`https://${o}${s.redirectPathAuthRefresh}?${t.stringify({requestedUri:n,nonce:e})}`}],"set-cookie":[{key:"set-cookie",value:`spa-auth-edge-nonce=${encodeURIComponent(e)}; ${s.cookieSettings.nonce}`},{key:"set-cookie",value:`spa-auth-edge-nonce-hmac=${encodeURIComponent(i.sign(e,s.nonceSigningSecret,s.nonceLength))}; ${s.cookieSettings.nonce}`}],...s.cloudFrontHeaders}};return s.logger.debug("Returning response:\n",r),r}return await s.jwtVerifier.verify(e),s.logger.debug("Returning request:\n",r),r}catch(e){s.logger.info(`Will redirect to Cognito for sign-in because: ${e}`);const r=c(),d={nonce:r,nonceHmac:i.sign(r,s.nonceSigningSecret,s.nonceLength),...a()};s.logger.debug("Using new state\n",d);const u=t.stringify({redirect_uri:`https://${o}${s.redirectPathSignIn}`,response_type:"code",client_id:s.clientId,state:i.urlSafe.stringify(Buffer.from(JSON.stringify({nonce:d.nonce,requestedUri:n})).toString("base64")),scope:s.oauthScopes.join(" "),code_challenge_method:"S256",code_challenge:d.pkceHash}),l={status:"307",statusDescription:"Temporary Redirect",headers:{location:[{key:"location",value:`https://${s.cognitoAuthDomain}/oauth2/authorize?${u}`}],"set-cookie":[{key:"set-cookie",value:`spa-auth-edge-nonce=${encodeURIComponent(d.nonce)}; ${s.cookieSettings.nonce}`},{key:"set-cookie",value:`spa-auth-edge-nonce-hmac=${encodeURIComponent(d.nonceHmac)}; ${s.cookieSettings.nonce}`},{key:"set-cookie",value:`spa-auth-edge-pkce=${encodeURIComponent(d.pkce)}; ${s.cookieSettings.nonce}`}],...s.cloudFrontHeaders}};return s.logger.debug("Returning response:\n",l),l}}})();var n=exports;for(var i in o)n[i]=o[i];o.__esModule&&Object.defineProperty(n,"__esModule",{value:!0})})();